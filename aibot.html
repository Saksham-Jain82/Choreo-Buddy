<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Choreobuddy - Chat Assistant</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#11b4d4",
                        "gold": "#d4af37",
                        "background-light": "#f6f8f8",
                        "background-dark": "#101f22",
                        "accent-teal": "#234248",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        .motif-border {
            border-image: linear-gradient(to right, #d4af37, #11b4d4) 1;
            border-bottom-width: 2px;
        }
        .indian-pattern {
            background-image: radial-gradient(#d4af37 0.5px, transparent 0.5px);
            background-size: 24px 24px;
            opacity: 0.05;
        }
        .glass-panel {
            background: rgba(35, 66, 72, 0.4);
            backdrop-filter: blur(8px);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes dot-flashing { 0% { background-color: #11b4d4; } 50%, 100% { background-color: rgba(17, 180, 212, 0.2); } }
        .dot-flashing { position: relative; width: 6px; height: 6px; border-radius: 5px; background-color: #11b4d4; animation: dot-flashing 1s infinite linear alternate; animation-delay: .5s; }
        .dot-flashing::before, .dot-flashing::after { content: ''; display: inline-block; position: absolute; top: 0; width: 6px; height: 6px; border-radius: 5px; background-color: #11b4d4; animation: dot-flashing 1s infinite alternate; }
        .dot-flashing::before { left: -12px; animation-delay: 0s; }
        .dot-flashing::after { left: 12px; animation-delay: 1s; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 antialiased">
<div class="flex h-screen overflow-hidden">
    <!-- Sidebar Navigation -->
    <aside class="w-80 flex flex-col border-r border-accent-teal bg-[#111f22] relative">
        <div class="indian-pattern absolute inset-0 pointer-events-none"></div>
        <div class="p-6 flex items-center gap-3 border-b border-accent-teal relative z-10">
            <div class="bg-gold/20 p-2 rounded-lg">
                <span class="material-symbols-outlined text-gold">architecture</span>
            </div>
            <div>
                <h1 class="text-white text-lg font-bold leading-tight">Choreobuddy</h1>
                <p class="text-primary text-xs font-medium uppercase tracking-wider">AI Dance Coach</p>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-6 relative z-10 no-scrollbar">
            <button onclick="clearChat()" class="w-full flex items-center justify-center gap-2 bg-primary hover:bg-primary/90 text-background-dark py-3 px-4 rounded-xl font-bold transition-all shadow-lg shadow-primary/20">
                <span class="material-symbols-outlined">add</span>
                <span>New Session</span>
            </button>
            <nav class="space-y-1">
                <div class="flex items-center gap-3 px-3 py-2 rounded-lg bg-accent-teal text-white cursor-pointer">
                    <span class="material-symbols-outlined">chat_bubble</span>
                    <span class="text-sm font-medium">Active Coach Chat</span>
                </div>
            </nav>
        </div>
        <!-- User Profile -->
        <div class="p-4 border-t border-accent-teal bg-accent-teal/20">
            <div class="flex items-center gap-3">
                <div class="size-10 rounded-full bg-slate-700 border-2 border-gold flex items-center justify-center overflow-hidden">
                    <span class="material-symbols-outlined text-gold">person</span>
                </div>
                <div class="flex-1 overflow-hidden">
                    <p class="text-sm font-bold text-white truncate">Anas</p>
                    <p class="text-xs text-slate-400 truncate">Senior Practitioner</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col relative bg-background-light dark:bg-background-dark">
        <header class="flex items-center justify-between px-8 py-4 border-b border-accent-teal glass-panel z-20">
            <div class="flex items-center gap-4">
                <div id="status-dot" class="size-2 rounded-full bg-green-500 animate-pulse"></div>
                <div>
                    <h2 class="text-white font-bold">Choreobuddy Coach Session</h2>
                    <p class="text-xs text-slate-400">Server connected via Node.js</p>
                </div>
            </div>
        </header>

        <!-- Chat Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-8 space-y-8 scroll-smooth no-scrollbar">
            <div id="messages-list" class="max-w-4xl mx-auto space-y-8">
                <!-- Messages will be injected here -->
            </div>
        </div>

        <!-- Chat Input Area -->
        <footer class="p-6 bg-background-dark/80 backdrop-blur-xl border-t border-accent-teal relative">
            <form id="chat-form" class="max-w-4xl mx-auto">
                <div class="flex items-end gap-3 bg-accent-teal/40 p-2 rounded-2xl border border-accent-teal ring-1 ring-gold/10">
                    <textarea id="user-input" class="flex-1 bg-transparent border-none focus:ring-0 text-white placeholder-slate-500 resize-none py-2 text-sm no-scrollbar" placeholder="Ask about a mudra, posture, or shloka..." rows="1"></textarea>
                    <button type="submit" class="p-3 bg-primary text-background-dark rounded-xl flex items-center justify-center hover:brightness-110 transition-all shadow-lg shadow-primary/30">
                        <span class="material-symbols-outlined font-bold">send</span>
                    </button>
                </div>
                <div class="mt-3 flex justify-center gap-4">
                    <p class="text-[10px] text-slate-500 uppercase tracking-widest flex items-center gap-1">
                        <span class="material-symbols-outlined text-xs">info</span>
                        AI responses are based on Abhinaya Darpana
                    </p>
                </div>
            </form>
        </footer>
    </main>
</div>

<script>
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const messagesList = document.getElementById('messages-list');
    const chatContainer = document.getElementById('chat-container');

    let chatHistory = [
        { role: "system", content: "You are Choreobuddy AI, a scholarly and encouraging Indian Classical Dance coach. Use bold for key terms. Refer to Abhinaya Darpana often." }
    ];

    // Initial welcome message
    window.onload = () => {
        appendMessage('assistant', "Namaste! Welcome to Choreobuddy. I'm your AI dance coach. How shall we refine your practice today?");
    };

    // Auto-resize textarea
    userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    async function handleMessage(e) {
        e.preventDefault();
        const text = userInput.value.trim();
        if (!text) return;

        // Reset input
        userInput.value = '';
        userInput.style.height = 'auto';

        // Add user message to UI
        appendMessage('user', text);
        
        // Show loader
        const loaderId = showLoader();

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages: [...chatHistory, { role: 'user', content: text }] })
            });

            const data = await response.json().catch(() => {
                throw new Error(`Server returned invalid response (status: ${response.status})`);
            });

            if (!response.ok) {
                throw new Error(data.error || `Server error: ${response.status}`);
            }

            if (data.error) throw new Error(data.error);

            const loaderElement = document.getElementById(loaderId);
            if (loaderElement) loaderElement.remove();

            const reply = data.choices?.[0]?.message?.content;
            if (!reply) throw new Error('Invalid response format from server');
            
            appendMessage('assistant', reply);
            
            // Update history
            chatHistory.push({ role: 'user', content: text }, { role: 'assistant', content: reply });

        } catch (error) {
            console.error("Chat Error:", error);
            const loaderElement = document.getElementById(loaderId);
            if (loaderElement) loaderElement.remove();
            appendMessage('assistant', `Error: ${error.message}. Ensure server is running with 'npm start' and .env file has OPENROUTER_API_KEY set.`);
        }
    }

    function appendMessage(role, text) {
        const isAI = role === 'assistant';
        const div = document.createElement('div');
        div.className = `flex gap-4 items-start ${isAI ? '' : 'justify-end'}`;

        const iconHtml = isAI ? `
            <div class="size-10 rounded-lg bg-gold/20 flex items-center justify-center shrink-0 border border-gold/30">
                <span class="material-symbols-outlined text-gold">auto_awesome</span>
            </div>` : '';

        const userAvatarHtml = !isAI ? `
            <div class="size-10 rounded-full bg-primary flex items-center justify-center shrink-0 border-2 border-primary/20">
                <span class="material-symbols-outlined text-background-dark font-bold">person</span>
            </div>` : '';

        div.innerHTML = `
            ${iconHtml}
            <div class="flex flex-col gap-2 ${isAI ? 'max-w-[85%]' : 'max-w-[70%] items-end'}">
                <div class="${isAI ? 'bg-accent-teal text-slate-100 rounded-tl-none border border-accent-teal' : 'bg-primary text-background-dark font-medium rounded-tr-none'} p-5 rounded-2xl shadow-xl">
                    <p class="leading-relaxed text-[15px] whitespace-pre-wrap">${formatText(text)}</p>
                </div>
            </div>
            ${userAvatarHtml}
        `;

        messagesList.appendChild(div);
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
    }

    function formatText(text) {
        // Simple markdown bolding support
        return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    }

    function showLoader() {
        const id = 'loader-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = 'flex gap-4 items-start';
        div.innerHTML = `
            <div class="size-10 rounded-lg bg-gold/5 flex items-center justify-center shrink-0 border border-gold/10">
                <span class="material-symbols-outlined text-gold/30 animate-spin">sync</span>
            </div>
            <div class="py-6 px-4"><div class="dot-flashing"></div></div>
        `;
        messagesList.appendChild(div);
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        return id;
    }

    function clearChat() {
        messagesList.innerHTML = '';
        chatHistory = [chatHistory[0]];
        appendMessage('assistant', "Session reset. How shall we begin?");
    }

    chatForm.addEventListener('submit', handleMessage);
</script>
</body>
</html>